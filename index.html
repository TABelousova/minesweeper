<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body id="wer">
    <div class="start_setting" id="start_setting">
        <form action="index.html" onsubmit="onSubm(event);" id="start_setting_form" name="start_setting_form">
            <p>Ширина игрового поля</p>
            <input type="text" size="20" name="n_value" id="n_value">
            <p>Количество бомб</p>
            <input type="text" size="20" name="m_value" id="m_value"><br>
            <p><input type="submit" value="Начать игру"></p>
        </form>
    </div>
    <!--игровое поле 5*5-->
    <div class="game_field" id="game_field">
        <span class="header">
        <span class="header-text">
            Осталось мин:
        </span>
        <span id="mineleft">
            3
        </span>
        </div>
        <table id="table">
        </table>
    </div>
    <script type="text/javascript"> 
        //количество открытых ячеек для поверки, есть ли неоткрытые не мины
        var count_cell = 0;
        //открыта ли хоть одна мина
        var lose = 0;
        //n - размерность поля m - количество мин
        // создание массива и заполнение нулями (нафига нулями??)
        var field = new Array();
        var n;
        var m;
        // разница между количеством мин и минами, помеченными игроком
        var mineleft;
        function create_field() {
        mineleft = m;
        document.getElementById("mineleft").innerText = mineleft;
        for (var i = 0; i < n; i++) {
            field[i] = new Array();
            var rowid = "row"+i;
            var newrow = document.createElement('tr');
            newrow.id = rowid;
            table.appendChild(newrow);
            for (var j = 0; j < n; j++) {
                field[i][j] = 0;
                var cellid = "cell"+i+"_"+j;
                var newcell = document.createElement('td');
                newcell.innerText = "?";
                newcell.id = cellid;
                document.getElementById(rowid).appendChild(newcell);
                newcell.onclick = onCellClick;
                newcell.oncontextmenu = onRightClick;
            }
        }
        //расстановка мин
        var t = 0;
        while (t < m) {
            i = Math.random() * (n - 1);
            i = Math.round(i);
            j = Math.random() * (n - 1);
            j = Math.round(j);
            if (field[i][j] == 0) { field[i][j] = '*'; t++; }
        }
        var r = 0;
        //подсчет количества соседних мин для каждой из клеток поля
        for (var i = 0; i < n; i++) {
            for (var j = 0; j < n; j++) {
                if (i > 0) { var i_min = i - 1 } else { var i_min = 0 };
                if (i < n - 1) { var i_max = i + 1 } else { var i_max = n - 1 };
                if (j > 0) { var j_min = j - 1 } else { var j_min = 0 };
                if (j < n - 1) { var j_max = j + 1 } else { var j_max = n - 1 };
                r = 0;
                for (var i1 = i_min; i1 <= i_max; i1++) {
                    for (var j1 = j_min; j1 <= j_max; j1++) {
                        if (field[i1][j1] == '*') r++;
                        if (field[i][j] != '*') { field[i][j] = r };
                    }
                }
            }
        }
        }
        //функция для дооткратия массива после окончания игры
        function showfield() {
            for (var i = 0; i < n; i++) {
            for (var j = 0; j < n; j++) {
                cellname="cell"+i+"_"+j;
                //открывает знаки вопроса
                if (document.getElementById(cellname).innerText=="?")
                {document.getElementById(cellname).innerText=field[i][j]};
                //открывает восклицательные знаки
                if (document.getElementById(cellname).innerText=="!")
                {document.getElementById(cellname).innerText=field[i][j];
                document.getElementById(cellname).style.color = "black";};
                //открывает неправильно отмеченные бомбы
                if ((document.getElementById(cellname).innerText=="M") &
                (field[i][j] != "*"))
                {document.getElementById(cellname).innerText=field[i][j];
                document.getElementById(cellname).style.color = "red"};
            }
        }
        }
        //обработка нажатия на ячейку
        function onCellClick(event) {
            //проверка, что мины еще не открыты
            if (lose != 1) {
                ide = event.target.id;
                var rt = /[^cell]/
                var ide2 = ide.match(rt);
                //разбор id элемента для определения i2 (координата по x)
                var i2r = /\d{1}/;
                var i2 = ide.match(i2r);
                //разбор id элемента для определения j2 (координата по y)
                var j2r = /\d{1}$/;
                var j2 = ide.match(j2r);
                //определение соответствующего координатам значения в массиве
                var val = field[i2][j2];
                //проверка, что данный элемент еще не был открыт
                if (document.getElementById(ide).innerText == '?') {
                    //если открыта мина, то игрок проиграл
                    if (field[i2][j2] == '*') {
                        alert('БАБАХ!!! Вы проиграли!');
                        document.getElementById(ide).innerText = field[i2][j2];
                        document.getElementById(ide).style.backgroundColor = "red";
                        lose = 1;
                        showfield();
                    }
                    else {
                        //если игрок не проиграл, то открывается значение количества мин вокруг ячейки
                        document.getElementById(ide).innerText = field[i2][j2];
                        //увеличиваем счетчик открытых ячеек
                        count_cell++;
                        //если ячейки без мин закончились, то игрок выиграл
                        if (count_cell == n * n - m) { alert('Поздравляю, Вы выиграли!'); lose = 1; showfield();}
                    }
                }
            }
        }
        function onSubm(event) {
            //debugger;
            //console.log;
            event.stopPropagation();
            event.preventDefault();
            //alert('submit!');
            n = document.forms["start_setting_form"].elements["n_value"].value;
            m = document.forms["start_setting_form"].elements["m_value"].value;
            create_field();
            document.getElementById("start_setting").style.visibility = "hidden";
            document.getElementById("game_field").style.visibility = "visible";
        }
        function onRightClick(event) {
        if (lose != 1) {
                ide = event.target.id;
                var rt = /[^cell]/
                var ide2 = ide.match(rt);
                //разбор id элемента для определения i2 (координата по x)
                var i2r = /\d{1}/;
                var i2 = ide.match(i2r);
                //разбор id элемента для определения j2 (координата по y)
                var j2r = /\d{1}$/;
                var j2 = ide.match(j2r);
                //определение соответствующего координатам значения в массиве
                var val = field[i2][j2];
                //если в клетке стоит ? заменяем его на метку мины M
                if (document.getElementById(ide).innerText == '?')
                {
                    // помечаем клетку как мину
                    document.getElementById(ide).innerText = "M"; 
                    document.getElementById(ide).style.color = "red";
                    // уменьшаем количество неотмеченных мин на 1
                    mineleft = mineleft-1;
                    document.getElementById("mineleft").innerText = mineleft;
                    
                } else {
                        //если на клетку поставлена мина, меняем ее на предупредительный знак
                    if (document.getElementById(ide).innerText == 'M')
                    {
                        document.getElementById(ide).innerText = "!"; 
                        document.getElementById(ide).style.color = "blue";
                        //увеличиваем количество неотмеченных мин
                        mineleft = mineleft+1;
                        document.getElementById("mineleft").innerText = mineleft;
                    }
                        else {
                            document.getElementById(ide).innerText = "?"; 
                            document.getElementById(ide).style.color = "black";
                        }
                    }

        }return false;}
    </script>

</body>

</html>